<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mohsen: US Stock Status Dashboard</title>
  <style>
    :root {
      --bg: #f4f8fc;
      --card: #ffffff;
      --text: #1d2b3a;
      --muted: #5c6f82;
      --green: #138a36;
      --red: #b42318;
      --green-soft: #e9f8ee;
      --red-soft: #fff0ef;
      --blue-soft: #e9f2ff;
      --amber-soft: #fff8e6;
      --line: #d9e2ec;
    }

    body {
      margin: 0;
      font-family: "DejaVu Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top right, #d8e9ff, var(--bg) 40%);
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
    }

    .meta {
      color: var(--muted);
      margin: 8px 0 20px;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(20, 39, 58, 0.06);
    }

    .card-winner {
      border-top: 4px solid var(--green);
      background: linear-gradient(180deg, var(--green-soft), #ffffff 42%);
    }

    .card-loser {
      border-top: 4px solid var(--red);
      background: linear-gradient(180deg, var(--red-soft), #ffffff 42%);
    }

    .card-history {
      border-top: 4px solid #2f6fed;
      background: linear-gradient(180deg, var(--blue-soft), #ffffff 45%);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      font-size: 0.85rem;
      color: var(--muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
      background: var(--blue-soft);
    }

    tbody tr:nth-child(odd) {
      background: #fbfdff;
    }

    tbody tr:hover {
      background: var(--amber-soft);
    }

    .pos {
      color: var(--green);
      font-weight: 700;
    }

    .neg {
      color: var(--red);
      font-weight: 700;
    }

    .error {
      background: #fff1f0;
      color: #7a271a;
      border: 1px solid #f8cfc9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .status {
      font-size: 0.82rem;
      font-weight: 700;
    }

    .status-winner {
      color: #0f6f2d;
      background: var(--green-soft);
      border: 1px solid #b7e6c2;
      border-radius: 999px;
      padding: 3px 8px;
      display: inline-block;
    }

    .status-loser {
      color: #9c2015;
      background: var(--red-soft);
      border: 1px solid #f0b7b1;
      border-radius: 999px;
      padding: 3px 8px;
      display: inline-block;
    }

    .status-new {
      color: var(--muted);
      background: #f2f6fa;
      border: 1px solid #d5e0ea;
      border-radius: 999px;
      padding: 3px 8px;
      display: inline-block;
    }

    .chart-wrap {
      position: relative;
      height: 280px;
      width: 100%;
    }

    #historyChart {
      width: 100%;
      height: 100%;
      display: block;
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 1.4rem;
      }

      th,
      td {
        font-size: 0.82rem;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Mohsen: US Stock Status Dashboard</h1>
    <p class="meta">Last refresh: {{ generated_at|date:"Y-m-d H:i:s" }} UTC</p>

    {% if error %}
      <div class="error">Could not refresh data: {{ error }}</div>
    {% endif %}

    <section class="grid">
      <article class="card card-winner">
        <h2>Top 10 Winners (Today)</h2>
        <table>
          <thead>
            <tr><th>Symbol</th><th>Price</th><th>Change %</th><th>Last Status</th></tr>
          </thead>
          <tbody>
            {% for stock in top_gainers %}
              <tr>
                <td>{{ stock.symbol }} - {{ stock.company_name }}</td>
                <td>${{ stock.price }}</td>
                <td class="{% if stock.change_pct >= 0 %}pos{% else %}neg{% endif %}">{{ stock.change_pct }}%</td>
                <td class="status {% if stock.previous_status == 'winner' %}status-winner{% elif stock.previous_status == 'loser' %}status-loser{% else %}status-new{% endif %}">
                  {{ stock.previous_status_label }}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </article>

      <article class="card card-loser">
        <h2>Top 10 Losers (Today)</h2>
        <table>
          <thead>
            <tr><th>Symbol</th><th>Price</th><th>Change %</th><th>Last Status</th></tr>
          </thead>
          <tbody>
            {% for stock in top_losers %}
              <tr>
                <td>{{ stock.symbol }} - {{ stock.company_name }}</td>
                <td>${{ stock.price }}</td>
                <td class="{% if stock.change_pct >= 0 %}pos{% else %}neg{% endif %}">{{ stock.change_pct }}%</td>
                <td class="status {% if stock.previous_status == 'winner' %}status-winner{% elif stock.previous_status == 'loser' %}status-loser{% else %}status-new{% endif %}">
                  {{ stock.previous_status_label }}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </article>
    </section>

    <section class="card card-history">
      <h2>10-Day Winners vs Losers Trend</h2>
      <p class="meta">Average daily change for top winners and top losers.</p>
      <div class="chart-wrap">
        <canvas id="historyChart"></canvas>
      </div>
    </section>

    <section class="card">
      <h2>All Tracked Stock Status</h2>
      <table>
        <thead>
          <tr><th>Symbol</th><th>Price</th><th>Previous Close</th><th>Change %</th></tr>
        </thead>
        <tbody>
          {% for stock in stocks %}
            <tr>
              <td>{{ stock.symbol }} - {{ stock.company_name }}</td>
              <td>${{ stock.price }}</td>
              <td>${{ stock.previous_close }}</td>
              <td class="{% if stock.change_pct >= 0 %}pos{% else %}neg{% endif %}">{{ stock.change_pct }}%</td>
            </tr>
          {% empty %}
            <tr><td colspan="4">No data available</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>
  <script>
    (function() {
      const chartData = {{ history_chart_json|safe }};
      const canvas = document.getElementById("historyChart");
      if (!canvas || !chartData || !chartData.labels || chartData.labels.length === 0) {
        return;
      }

      const ctx = canvas.getContext("2d");
      const parent = canvas.parentElement;
      const width = Math.max(320, parent.clientWidth);
      const height = Math.max(240, parent.clientHeight);
      canvas.width = width;
      canvas.height = height;

      const padding = { top: 18, right: 18, bottom: 36, left: 46 };
      const plotW = width - padding.left - padding.right;
      const plotH = height - padding.top - padding.bottom;

      const winner = chartData.winner_avg_change || [];
      const loser = chartData.loser_avg_change || [];
      const values = winner.concat(loser).filter(v => v !== null && v !== undefined);
      const minY = Math.min.apply(null, values);
      const maxY = Math.max.apply(null, values);
      const range = (maxY - minY) || 1;

      function x(i) {
        if (chartData.labels.length === 1) return padding.left + (plotW / 2);
        return padding.left + (i * (plotW / (chartData.labels.length - 1)));
      }

      function y(v) {
        return padding.top + ((maxY - v) / range) * plotH;
      }

      ctx.clearRect(0, 0, width, height);
      ctx.strokeStyle = "#d9e2ec";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top);
      ctx.lineTo(padding.left, height - padding.bottom);
      ctx.lineTo(width - padding.right, height - padding.bottom);
      ctx.stroke();

      ctx.fillStyle = "#5c6f82";
      ctx.font = "12px DejaVu Sans";
      ctx.textAlign = "center";
      chartData.labels.forEach((label, i) => {
        const lx = x(i);
        ctx.fillText(label.slice(5), lx, height - 12);
      });

      function drawSeries(series, color) {
        const points = series.map((v, i) => (v === null || v === undefined) ? null : [x(i), y(v)]);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        let started = false;
        points.forEach((p) => {
          if (!p) return;
          if (!started) {
            ctx.moveTo(p[0], p[1]);
            started = true;
          } else {
            ctx.lineTo(p[0], p[1]);
          }
        });
        ctx.stroke();

        ctx.fillStyle = color;
        points.forEach((p) => {
          if (!p) return;
          ctx.beginPath();
          ctx.arc(p[0], p[1], 3, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      drawSeries(winner, "#138a36");
      drawSeries(loser, "#b42318");

      ctx.fillStyle = "#138a36";
      ctx.fillRect(width - 170, 16, 10, 10);
      ctx.fillStyle = "#1d2b3a";
      ctx.fillText("Winners Avg %", width - 110, 25);
      ctx.fillStyle = "#b42318";
      ctx.fillRect(width - 170, 34, 10, 10);
      ctx.fillStyle = "#1d2b3a";
      ctx.fillText("Losers Avg %", width - 106, 43);
    })();
  </script>
</body>
</html>
